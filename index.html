<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal - Rockview University</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #1e40af;
            --primary-dark: #1e3a8a;
            --primary-light: #3b82f6;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --background: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .nav-item {
            position: relative;
            transition: all 0.3s ease;
        }
        
        .nav-item.active {
            color: var(--primary);
            background: rgba(30, 64, 175, 0.1);
        }
        
        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--primary);
            border-radius: 2px;
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin: 0 1rem;
            opacity: 0.5;
            transition: all 0.3s ease;
        }
        
        .step.active {
            opacity: 1;
        }
        
        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary-light);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 0.5rem;
        }
        
        .step.active .step-number {
            background: var(--primary);
        }
        
        .payment-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .payment-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
        }
        
        .payment-card.selected {
            border-color: var(--primary);
            background: rgba(30, 64, 175, 0.05);
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-success { background: #d1fae5; color: var(--success); }
        .status-pending { background: #fef3c7; color: var(--warning); }
        .status-failed { background: #fee2e2; color: var(--error); }
        
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            color: white;
            z-index: 1000;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success { background: var(--success); }
        .notification.error { background: var(--error); }
        .notification.warning { background: var(--warning); }
        .notification.info { background: var(--primary); }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .step-content {
            display: none;
        }
        
        .step-content.active {
            display: block;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Notification System -->
    <div id="notification" class="notification hidden">
        <div class="flex items-center">
            <i class="fas fa-check-circle mr-3"></i>
            <span id="notificationMessage"></span>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="min-h-screen flex">
        <!-- Sidebar Navigation -->
        <aside class="w-64 glass-card min-h-screen p-6">
            <div class="flex items-center space-x-3 mb-8">
                <div class="w-10 h-10 bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg flex items-center justify-center">
                    <i class="fas fa-graduation-cap text-white"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg text-gray-800">ROCKVIEW</h1>
                    <p class="text-xs text-gray-500">UNIVERSITY</p>
                </div>
            </div>
            
            <nav class="space-y-2">
                <button onclick="showSection('dashboard')" class="nav-item w-full text-left p-3 rounded-lg flex items-center space-x-3 text-gray-600 hover:text-blue-600 hover:bg-blue-50 transition-all duration-200 active">
                    <i class="fas fa-home w-5"></i>
                    <span>Dashboard</span>
                </button>
                
                <button onclick="showSection('profile')" class="nav-item w-full text-left p-3 rounded-lg flex items-center space-x-3 text-gray-600 hover:text-blue-600 hover:bg-blue-50 transition-all duration-200">
                    <i class="fas fa-user w-5"></i>
                    <span>Profile</span>
                </button>
                
                <button onclick="showSection('payments')" class="nav-item w-full text-left p-3 rounded-lg flex items-center space-x-3 text-gray-600 hover:text-blue-600 hover:bg-blue-50 transition-all duration-200">
                    <i class="fas fa-credit-card w-5"></i>
                    <span>Make Payment</span>
                </button>
                
                <button onclick="showSection('history')" class="nav-item w-full text-left p-3 rounded-lg flex items-center space-x-3 text-gray-600 hover:text-blue-600 hover:bg-blue-50 transition-all duration-200">
                    <i class="fas fa-history w-5"></i>
                    <span>Payment History</span>
                </button>
                
                <button onclick="showSection('clearance')" class="nav-item w-full text-left p-3 rounded-lg flex items-center space-x-3 text-gray-600 hover:text-blue-600 hover:bg-blue-50 transition-all duration-200">
                    <i class="fas fa-clipboard-check w-5"></i>
                    <span>Clearance Status</span>
                </button>
            </nav>
            
            <div class="mt-auto pt-8 border-t border-gray-200">
                <button onclick="handleLogout()" class="w-full text-left p-3 rounded-lg flex items-center space-x-3 text-red-600 hover:bg-red-50 transition-all duration-200">
                    <i class="fas fa-sign-out-alt w-5"></i>
                    <span>Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-8">
            <!-- Header -->
            <header class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-2xl font-bold text-white">Student Portal</h1>
                    <p class="text-blue-100">Welcome to Rockview University Payment System</p>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <p class="text-white font-medium" id="headerStudentName">Loading...</p>
                        <p class="text-blue-200 text-sm" id="headerStudentNumber">RVU-XXXXXX</p>
                    </div>
                    <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-lg">
                        <i class="fas fa-user-graduate text-blue-600 text-xl"></i>
                    </div>
                </div>
            </header>

            <!-- Content Sections -->
            <div class="space-y-6">
                <!-- Dashboard Section -->
                <section id="dashboard" class="section glass-card rounded-2xl p-8 active fade-in">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-6 text-white">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-blue-100">Current Balance</p>
                                    <h3 class="text-2xl font-bold mt-2" id="currentBalance">K0.00</h3>
                                </div>
                                <i class="fas fa-wallet text-2xl opacity-80"></i>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-xl p-6 text-white">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-green-100">Payments Made</p>
                                    <h3 class="text-2xl font-bold mt-2" id="paymentsCount">0</h3>
                                </div>
                                <i class="fas fa-receipt text-2xl opacity-80"></i>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl p-6 text-white">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-purple-100">Clearance Status</p>
                                    <h3 class="text-2xl font-bold mt-2" id="clearanceStatus">Pending</h3>
                                </div>
                                <i class="fas fa-clipboard-list text-2xl opacity-80"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-lg font-semibold mb-4">Recent Payments</h3>
                            <div id="recentPayments" class="space-y-3">
                                <div class="flex items-center justify-center py-8 text-gray-500">
                                    <i class="fas fa-history text-3xl mb-3 opacity-50"></i>
                                    <p>No recent payments</p>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="text-lg font-semibold mb-4">Quick Actions</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <button onclick="showSection('payments')" class="p-4 bg-white rounded-xl border border-gray-200 hover:border-blue-500 transition-all duration-200 text-left group">
                                    <i class="fas fa-credit-card text-blue-600 text-xl mb-2"></i>
                                    <p class="font-medium">Make Payment</p>
                                    <p class="text-sm text-gray-500 mt-1">Pay fees online</p>
                                </button>
                                
                                <button onclick="downloadClearanceForm()" class="p-4 bg-white rounded-xl border border-gray-200 hover:border-green-500 transition-all duration-200 text-left group">
                                    <i class="fas fa-file-download text-green-600 text-xl mb-2"></i>
                                    <p class="font-medium">Clearance Form</p>
                                    <p class="text-sm text-gray-500 mt-1">Download certificate</p>
                                </button>
                                
                                <button onclick="showSection('history')" class="p-4 bg-white rounded-xl border border-gray-200 hover:border-purple-500 transition-all duration-200 text-left group">
                                    <i class="fas fa-history text-purple-600 text-xl mb-2"></i>
                                    <p class="font-medium">Payment History</p>
                                    <p class="text-sm text-gray-500 mt-1">View all transactions</p>
                                </button>
                                
                                <button onclick="showSection('profile')" class="p-4 bg-white rounded-xl border border-gray-200 hover:border-orange-500 transition-all duration-200 text-left group">
                                    <i class="fas fa-user-cog text-orange-600 text-xl mb-2"></i>
                                    <p class="font-medium">Profile</p>
                                    <p class="text-sm text-gray-500 mt-1">Update information</p>
                                </button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Profile Section -->
                <section id="profile" class="section glass-card rounded-2xl p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Student Profile</h2>
                        <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                            ID: <span id="displayUserId">RVU-XXXXXX</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div class="p-6 bg-white rounded-xl border border-gray-200">
                                <h3 class="text-lg font-semibold mb-4 text-gray-800">Personal Information</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="text-sm text-gray-500">Full Name</label>
                                        <p class="font-medium" id="profileName">Loading...</p>
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-500">Student Number</label>
                                        <p class="font-medium" id="profileStudentNumber">Loading...</p>
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-500">Email Address</label>
                                        <p class="font-medium" id="profileEmail">Loading...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-6">
                            <div class="p-6 bg-white rounded-xl border border-gray-200">
                                <h3 class="text-lg font-semibold mb-4 text-gray-800">Academic Information</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="text-sm text-gray-500">Faculty/Program</label>
                                        <p class="font-medium" id="profileClass">Loading...</p>
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-500">Academic Level</label>
                                        <p class="font-medium" id="profileLevel">Loading...</p>
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-500">Status</label>
                                        <p class="font-medium">
                                            <span class="status-badge status-success" id="profileStatus">Active</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Payments Section -->
                <section id="payments" class="section glass-card rounded-2xl p-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Make Payment</h2>
                    
                    <div class="max-w-4xl mx-auto">
                        <!-- Step 1: Select Term -->
                        <div id="step-terms" class="step-content active fade-in">
                            <div class="step-indicator">
                                <div class="step active">
                                    <div class="step-number">1</div>
                                    <span>Select Term</span>
                                </div>
                                <div class="step">
                                    <div class="step-number">2</div>
                                    <span>Choose Item</span>
                                </div>
                                <div class="step">
                                    <div class="step-number">3</div>
                                    <span>Payment Method</span>
                                </div>
                                <div class="step">
                                    <div class="step-number">4</div>
                                    <span>Confirm</span>
                                </div>
                            </div>
                            
                            <h3 class="text-xl font-semibold text-center mb-8">Select Academic Term</h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="payment-card bg-white rounded-xl p-6 border-2 border-gray-200 cursor-pointer transition-all duration-300" onclick="selectTerm(1)">
                                    <div class="text-center mb-4">
                                        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                            <span class="text-2xl font-bold text-blue-600">1</span>
                                        </div>
                                        <h4 class="font-semibold text-lg">Term 1</h4>
                                        <p class="text-gray-500 text-sm mt-1">Tuition & Materials</p>
                                    </div>
                                    <div class="text-center">
                                        <span class="text-2xl font-bold text-green-600">K2,300</span>
                                        <p class="text-gray-500 text-xs mt-1">Starting from</p>
                                    </div>
                                </div>
                                
                                <div class="payment-card bg-white rounded-xl p-6 border-2 border-gray-200 cursor-pointer transition-all duration-300" onclick="selectTerm(2)">
                                    <div class="text-center mb-4">
                                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                            <span class="text-2xl font-bold text-green-600">2</span>
                                        </div>
                                        <h4 class="font-semibold text-lg">Term 2</h4>
                                        <p class="text-gray-500 text-sm mt-1">Tuition & Stationery</p>
                                    </div>
                                    <div class="text-center">
                                        <span class="text-2xl font-bold text-green-600">K2,150</span>
                                        <p class="text-gray-500 text-xs mt-1">Starting from</p>
                                    </div>
                                </div>
                                
                                <div class="payment-card bg-white rounded-xl p-6 border-2 border-gray-200 cursor-pointer transition-all duration-300" onclick="selectTerm(3)">
                                    <div class="text-center mb-4">
                                        <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                            <span class="text-2xl font-bold text-purple-600">3</span>
                                        </div>
                                        <h4 class="font-semibold text-lg">Term 3</h4>
                                        <p class="text-gray-500 text-sm mt-1">Tuition & Exams</p>
                                    </div>
                                    <div class="text-center">
                                        <span class="text-2xl font-bold text-green-600">K2,300</span>
                                        <p class="text-gray-500 text-xs mt-1">Starting from</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Select Items -->
                        <div id="step-items" class="step-content">
                            <!-- Step content will be populated dynamically -->
                        </div>

                        <!-- Step 3: Payment Method -->
                        <div id="step-method" class="step-content">
                            <!-- Step content will be populated dynamically -->
                        </div>

                        <!-- Step 4: Confirm Payment -->
                        <div id="step-confirm" class="step-content">
                            <!-- Step content will be populated dynamically -->
                        </div>

                        <!-- Step 5: Payment Details -->
                        <div id="step-details" class="step-content">
                            <!-- Step content will be populated dynamically -->
                        </div>

                        <!-- Step 6: Processing -->
                        <div id="step-processing" class="step-content">
                            <!-- Step content will be populated dynamically -->
                        </div>

                        <!-- Step 7: Receipt -->
                        <div id="step-receipt" class="step-content">
                            <!-- Step content will be populated dynamically -->
                        </div>
                    </div>
                </section>

                <!-- Payment History Section -->
                <section id="history" class="section glass-card rounded-2xl p-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Payment History</h2>
                    
                    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Term</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Receipt</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody" class="divide-y divide-gray-200">
                                <tr>
                                    <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                                        <i class="fas fa-history text-3xl mb-3 opacity-50"></i>
                                        <p>Loading payment history...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Clearance Status Section -->
                <section id="clearance" class="section glass-card rounded-2xl p-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Clearance Status</h2>
                    <p class="text-gray-600 mb-6">Track your payment requirements for each academic term</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="clearanceContainer">
                        <!-- Clearance status will be populated dynamically -->
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyClWU6f1WdKKnJo3a4EEdusWdKdXd5LL4A",
            authDomain: "rockview-university-46057.firebaseapp.com",
            projectId: "rockview-university-46057",
            storageBucket: "rockview-university-46057.firebasestorage.app",
            messagingSenderId: "481696025854",
            appId: "1:481696025854:web:a2067380abde8f040c69af"
        };

        // Initialize Firebase
        let db;
        let auth;
        
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
        }

        // Current state
        let currentPayment = {
            term: null,
            item: null,
            amount: 0,
            method: null,
            methodName: null,
            transactionDetail: null,
            transactionId: null,
            date: null,
            receiptNumber: null
        };

        let currentUser = null;
        let useLocalStorage = false;

        // Utility Functions
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const messageEl = document.getElementById('notificationMessage');
            
            notification.className = `notification ${type} hidden`;
            messageEl.textContent = message;
            
            // Show notification
            setTimeout(() => {
                notification.classList.remove('hidden');
                notification.classList.add('show');
            }, 100);
            
            // Hide after 5 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.classList.add('hidden');
                }, 300);
            }, 5000);
        }

        function formatCurrency(amount) {
            return `K${(amount || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        // Student Data Management
        async function getStudentData(user) {
            try {
                console.log('Getting student data for:', user.uid);
                
                // Try to get student data from Firestore
                const studentDoc = await db.collection('students').doc(user.uid).get();
                
                if (studentDoc.exists) {
                    console.log('Student data found:', studentDoc.data());
                    return studentDoc.data();
                } else {
                    console.log('No student data found, creating default...');
                    // Create default student data
                    const studentData = {
                        id: user.uid,
                        email: user.email,
                        fullName: user.displayName || user.email.split('@')[0],
                        studentNumber: `RVU-${Date.now().toString().slice(-6)}`,
                        program: 'Computer Science',
                        level: '1st Year',
                        status: 'active',
                        role: 'student',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    // Save to Firestore
                    await db.collection('students').doc(user.uid).set(studentData);
                    console.log('Default student data created');
                    return studentData;
                }
            } catch (error) {
                console.error('Error getting student data:', error);
                throw new Error('Unable to load student data: ' + error.message);
            }
        }

        // Save payment to Firestore
        async function savePayment(paymentData) {
            try {
                await db.collection('payments').doc(paymentData.id).set(paymentData);
                console.log('Payment saved to Firestore:', paymentData.id);
                return true;
            } catch (error) {
                console.error('Error saving payment:', error);
                return false;
            }
        }

        // Load payments from Firestore
        async function loadPayments(studentId) {
            try {
                const paymentsSnapshot = await db.collection('payments')
                    .where('studentId', '==', studentId)
                    .orderBy('timestamp', 'desc')
                    .limit(10)
                    .get();
                
                const payments = [];
                paymentsSnapshot.forEach(doc => {
                    payments.push(doc.data());
                });
                return payments;
            } catch (error) {
                console.error('Error loading payments:', error);
                return [];
            }
        }

        // Navigation
        window.showSection = function(sectionId) {
            // Update navigation tabs
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.textContent.includes(sectionId.charAt(0).toUpperCase() + sectionId.slice(1)) || 
                    (sectionId === 'dashboard' && item.textContent.includes('Dashboard'))) {
                    item.classList.add('active');
                }
            });

            // Update sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');

            // Load section-specific data
            if (sectionId === 'history') {
                loadPaymentHistory();
            } else if (sectionId === 'clearance') {
                loadClearanceStatus();
            } else if (sectionId === 'dashboard') {
                loadDashboardData();
            }
        }

        // Payment Flow
        window.updatePaymentStep = function(stepId) {
            document.querySelectorAll('.step-content').forEach(step => {
                step.classList.remove('active');
            });
            document.getElementById(stepId).classList.add('active');
            
            // Update step indicator
            const steps = document.querySelectorAll('.step');
            steps.forEach(step => step.classList.remove('active'));
            
            if (stepId === 'step-terms') steps[0].classList.add('active');
            if (stepId === 'step-items') steps[1].classList.add('active');
            if (stepId === 'step-method') steps[2].classList.add('active');
            if (stepId === 'step-confirm' || stepId === 'step-details' || 
                stepId === 'step-processing' || stepId === 'step-receipt') {
                steps[3].classList.add('active');
            }
        }

        window.selectTerm = async function(term) {
            if (!currentUser) {
                showNotification('Please log in to make payments', 'error');
                return;
            }

            currentPayment.term = term;
            
            // Update UI
            document.querySelectorAll('.payment-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Show loading state
            const stepItems = document.getElementById('step-items');
            stepItems.innerHTML = `
                <div class="text-center py-12">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-gray-500">Loading payment items...</p>
                </div>
            `;
            
            updatePaymentStep('step-items');
            
            // Simulate loading items
            setTimeout(() => {
                const items = getPaymentItemsForTerm(term);
                renderPaymentItems(items);
            }, 1000);
        }

        function getPaymentItemsForTerm(term) {
            if (term === 1) {
                return [
                    { id: 'tuition', name: 'Tuition Fee', amount: 2300, description: 'Mandatory term tuition' },
                    { id: 'cement', name: '3 Bags of Cement', amount: 510, description: 'Contribution to infrastructure' },
                    { id: 'paper_ream', name: 'Ream of Paper', amount: 100, description: 'Stationery contribution' },
                    { id: 'library', name: 'Library Fee', amount: 100, description: 'Access to library services' }
                ];
            } else if (term === 2) {
                return [
                    { id: 'tuition', name: 'Tuition Fee', amount: 2150, description: 'Mandatory term tuition' },
                    { id: 'paper_ream', name: 'Ream of Paper', amount: 100, description: 'Stationery contribution' }
                ];
            } else if (term === 3) {
                return [
                    { id: 'tuition', name: 'Tuition Fee', amount: 2300, description: 'Mandatory term tuition' },
                    { id: 'paper_ream', name: 'Ream of Paper', amount: 100, description: 'Stationery contribution' },
                    { id: 'exam_fee', name: 'Exam Fee', amount: 500, description: 'Final examination fee' }
                ];
            }
            return [];
        }

        function renderPaymentItems(items) {
            const stepItems = document.getElementById('step-items');
            
            stepItems.innerHTML = `
                <div class="step-indicator">
                    <div class="step">
                        <div class="step-number">1</div>
                        <span>Select Term</span>
                    </div>
                    <div class="step active">
                        <div class="step-number">2</div>
                        <span>Choose Item</span>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <span>Payment Method</span>
                    </div>
                    <div class="step">
                        <div class="step-number">4</div>
                        <span>Confirm</span>
                    </div>
                </div>
                
                <h3 class="text-xl font-semibold text-center mb-8">Select Payment Item for Term ${currentPayment.term}</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8" id="itemsGrid">
                    ${items.map(item => `
                        <div class="payment-card bg-white rounded-xl p-6 border-2 border-gray-200 cursor-pointer transition-all duration-300" onclick="selectPaymentItem(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                            <h4 class="font-semibold text-lg mb-2">${item.name}</h4>
                            <p class="text-gray-500 text-sm mb-4">${item.description}</p>
                            <div class="flex justify-between items-center">
                                <span class="text-2xl font-bold text-green-600">${formatCurrency(item.amount)}</span>
                                <i class="fas fa-arrow-right text-gray-400"></i>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="flex justify-between">
                    <button class="px-6 py-3 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300 transition-all duration-200" onclick="updatePaymentStep('step-terms')">
                        <i class="fas fa-arrow-left mr-2"></i> Back to Terms
                    </button>
                </div>
            `;
        }

        function selectPaymentItem(item) {
            currentPayment.item = item.name;
            currentPayment.amount = item.amount;
            
            // Update UI
            document.querySelectorAll('#itemsGrid .payment-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Render confirmation step
            renderConfirmationStep();
        }

        function renderConfirmationStep() {
            const stepConfirm = document.getElementById('step-confirm');
            
            stepConfirm.innerHTML = `
                <div class="step-indicator">
                    <div class="step">
                        <div class="step-number">1</div>
                        <span>Select Term</span>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <span>Choose Item</span>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <span>Payment Method</span>
                    </div>
                    <div class="step active">
                        <div class="step-number">4</div>
                        <span>Confirm</span>
                    </div>
                </div>
                
                <h3 class="text-xl font-semibold text-center mb-8">Confirm Payment</h3>
                
                <div class="bg-white rounded-xl p-6 border border-gray-200 mb-8">
                    <div class="space-y-4">
                        <div class="flex justify-between py-3 border-b border-gray-100">
                            <span class="text-gray-600">Item:</span>
                            <strong>${currentPayment.item}</strong>
                        </div>
                        <div class="flex justify-between py-3 border-b border-gray-100">
                            <span class="text-gray-600">Term:</span>
                            <strong>Term ${currentPayment.term}</strong>
                        </div>
                        <div class="flex justify-between py-3">
                            <span class="text-gray-600">Amount:</span>
                            <strong class="text-2xl text-green-600">${formatCurrency(currentPayment.amount)}</strong>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-between">
                    <button class="px-6 py-3 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300 transition-all duration-200" onclick="updatePaymentStep('step-items')">
                        <i class="fas fa-arrow-left mr-2"></i> Back to Items
                    </button>
                    <button class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-all duration-200" onclick="proceedToPayment()">
                        Proceed to Pay <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            `;
            
            updatePaymentStep('step-confirm');
        }

        window.proceedToPayment = function() {
            renderPaymentMethodStep();
        }

        function renderPaymentMethodStep() {
            const stepMethod = document.getElementById('step-method');
            
            stepMethod.innerHTML = `
                <div class="step-indicator">
                    <div class="step">
                        <div class="step-number">1</div>
                        <span>Select Term</span>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <span>Choose Item</span>
                    </div>
                    <div class="step active">
                        <div class="step-number">3</div>
                        <span>Payment Method</span>
                    </div>
                    <div class="step">
                        <div class="step-number">4</div>
                        <span>Confirm</span>
                    </div>
                </div>
                
                <h3 class="text-xl font-semibold text-center mb-8">Select Payment Method</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="payment-card bg-white rounded-xl p-6 border-2 border-gray-200 cursor-pointer transition-all duration-300" onclick="selectPaymentMethod('IZB Bank', 'izb')">
                        <div class="text-center mb-4">
                            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-university text-blue-600 text-2xl"></i>
                            </div>
                            <h4 class="font-semibold text-lg">IZB Bank</h4>
                            <p class="text-gray-500 text-sm mt-1">Bank Transfer / Deposit</p>
                        </div>
                    </div>
                    
                    <div class="payment-card bg-white rounded-xl p-6 border-2 border-gray-200 cursor-pointer transition-all duration-300" onclick="selectPaymentMethod('Airtel Money', 'airtel')">
                        <div class="text-center mb-4">
                            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-mobile-alt text-green-600 text-2xl"></i>
                            </div>
                            <h4 class="font-semibold text-lg">Airtel Money</h4>
                            <p class="text-gray-500 text-sm mt-1">Mobile Wallet</p>
                        </div>
                    </div>
                    
                    <div class="payment-card bg-white rounded-xl p-6 border-2 border-gray-200 cursor-pointer transition-all duration-300" onclick="selectPaymentMethod('MTN Money', 'mtn')">
                        <div class="text-center mb-4">
                            <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-sim-card text-yellow-600 text-2xl"></i>
                            </div>
                            <h4 class="font-semibold text-lg">MTN Money</h4>
                            <p class="text-gray-500 text-sm mt-1">Mobile Wallet</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-between">
                    <button class="px-6 py-3 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300 transition-all duration-200" onclick="updatePaymentStep('step-confirm')">
                        <i class="fas fa-arrow-left mr-2"></i> Back to Confirm
                    </button>
                </div>
            `;
            
            updatePaymentStep('step-method');
        }

        window.selectPaymentMethod = function(methodName, methodId) {
            currentPayment.method = methodId;
            currentPayment.methodName = methodName;
            
            // Update UI
            document.querySelectorAll('#step-method .payment-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            renderPaymentDetailsStep();
        }

        function renderPaymentDetailsStep() {
            const stepDetails = document.getElementById('step-details');
            
            const detailLabel = currentPayment.method === 'izb' ? 
                'Bank Transfer Reference / Account Number' : 
                'Mobile Money Transaction ID';
                
            stepDetails.innerHTML = `
                <div class="step-indicator">
                    <div class="step">
                        <div class="step-number">1</div>
                        <span>Select Term</span>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <span>Choose Item</span>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <span>Payment Method</span>
                    </div>
                    <div class="step active">
                        <div class="step-number">4</div>
                        <span>Confirm</span>
                    </div>
                </div>
                
                <h3 class="text-xl font-semibold text-center mb-8">Enter ${currentPayment.methodName} Details</h3>
                
                <div class="bg-white rounded-xl p-6 border border-gray-200 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-gray-600">${currentPayment.item} (Term ${currentPayment.term})</span>
                        <strong class="text-2xl text-green-600">${formatCurrency(currentPayment.amount)}</strong>
                    </div>
                    <p class="text-gray-500 text-sm">
                        Please provide the transaction reference or account number used for the payment.
                    </p>
                </div>
                
                <form id="paymentForm" onsubmit="event.preventDefault(); initiatePayment();">
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">${detailLabel}</label>
                        <input type="text" id="paymentDetail" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                               placeholder="Enter your transaction details">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-all duration-200 mb-4">
                        Initiate Payment
                    </button>
                </form>
                
                <button class="w-full bg-gray-200 text-gray-800 py-3 rounded-lg font-semibold hover:bg-gray-300 transition-all duration-200" onclick="updatePaymentStep('step-method')">
                    <i class="fas fa-arrow-left mr-2"></i> Back to Methods
                </button>
            `;
            
            updatePaymentStep('step-details');
        }

        window.initiatePayment = async function() {
            if (!currentUser) {
                showNotification('Please log in to make payments', 'error');
                return;
            }

            currentPayment.transactionDetail = document.getElementById('paymentDetail').value.trim();
            
            if (!currentPayment.transactionDetail) {
                showNotification('Please enter transaction details', 'error');
                return;
            }
            
            // Show processing step
            renderProcessingStep();
            
            try {
                // Generate unique IDs
                const paymentId = `PAY-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                const receiptNumber = `RCP-${Date.now()}`;
                
                // Create payment data
                const paymentData = {
                    id: paymentId,
                    receiptNumber: receiptNumber,
                    studentId: currentUser.id,
                    studentName: currentUser.fullName,
                    studentNumber: currentUser.studentNumber,
                    program: currentUser.program,
                    term: currentPayment.term,
                    item: currentPayment.item,
                    amount: currentPayment.amount,
                    method: currentPayment.method,
                    methodName: currentPayment.methodName,
                    transactionDetail: currentPayment.transactionDetail,
                    transactionId: `TX-${Date.now()}`,
                    status: 'Success',
                    date: new Date().toISOString().split('T')[0],
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Save payment
                const saved = await savePayment(paymentData);
                
                if (saved) {
                    // Update current payment with response data
                    currentPayment.transactionId = paymentData.transactionId;
                    currentPayment.date = paymentData.date;
                    currentPayment.id = paymentId;
                    currentPayment.receiptNumber = receiptNumber;
                    
                    // Show success
                    setTimeout(() => {
                        renderReceiptStep();
                        showNotification(`Payment processed and saved successfully!`, 'success');
                        
                        // Refresh data
                        loadPaymentHistory();
                        loadClearanceStatus();
                        loadDashboardData();
                    }, 2000);
                } else {
                    throw new Error('Failed to save payment');
                }
                
            } catch (error) {
                console.error('Error processing payment:', error);
                showNotification('Payment failed: ' + error.message, 'error');
                updatePaymentStep('step-details');
            }
        }

        function renderProcessingStep() {
            const stepProcessing = document.getElementById('step-processing');
            
            stepProcessing.innerHTML = `
                <div class="text-center py-12">
                    <div class="loading-spinner mx-auto mb-6"></div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Processing Payment</h3>
                    <p class="text-gray-500">Verifying transaction details with ${currentPayment.methodName}...</p>
                    <p class="text-gray-400 text-sm mt-2">Saving payment record...</p>
                </div>
            `;
            
            updatePaymentStep('step-processing');
        }

        function renderReceiptStep() {
            const stepReceipt = document.getElementById('step-receipt');
            
            stepReceipt.innerHTML = `
                <div class="max-w-md mx-auto bg-white rounded-2xl p-8 border-2 border-green-500 text-center">
                    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-check text-green-500 text-3xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-green-600 mb-2">Payment Successful!</h3>
                    <p class="text-gray-600 mb-6">Your payment has been processed and saved successfully</p>
                    
                    <div class="bg-gray-50 rounded-xl p-6 text-left mb-6">
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Transaction ID:</span>
                                <strong>${currentPayment.transactionId}</strong>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Receipt Number:</span>
                                <strong>${currentPayment.receiptNumber}</strong>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Item Paid:</span>
                                <strong>${currentPayment.item}</strong>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Amount Paid:</span>
                                <strong class="text-green-600">${formatCurrency(currentPayment.amount)}</strong>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Payment Method:</span>
                                <strong>${currentPayment.methodName}</strong>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Date:</span>
                                <strong>${currentPayment.date}</strong>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <button class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-all duration-200" onclick="downloadReceipt()">
                            <i class="fas fa-download mr-2"></i> Download Receipt
                        </button>
                        <button class="w-full bg-gray-200 text-gray-800 py-3 rounded-lg font-semibold hover:bg-gray-300 transition-all duration-200" onclick="newPayment()">
                            Make Another Payment
                        </button>
                    </div>
                </div>
            `;
            
            updatePaymentStep('step-receipt');
        }

        window.newPayment = function() {
            currentPayment = {
                term: null,
                item: null,
                amount: 0,
                method: null,
                methodName: null,
                transactionDetail: null,
                transactionId: null,
                date: null,
                receiptNumber: null
            };
            
            updatePaymentStep('step-terms');
        }

        // Real-time Receipt Generation
        window.downloadReceipt = async function() {
            try {
                showNotification('Generating receipt...', 'info');
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Get the latest payment data from Firestore
                let paymentData = null;
                if (currentPayment.id) {
                    const docRef = await db.collection('payments').doc(currentPayment.id).get();
                    if (docRef.exists) {
                        paymentData = docRef.data();
                    }
                }
                
                // Use current payment data if Firestore data is not available
                if (!paymentData) {
                    paymentData = {
                        receiptNumber: currentPayment.receiptNumber || `RCP-${Date.now()}`,
                        studentName: currentUser.fullName,
                        studentNumber: currentUser.studentNumber,
                        program: currentUser.program,
                        item: currentPayment.item,
                        term: currentPayment.term,
                        methodName: currentPayment.methodName,
                        transactionId: currentPayment.transactionId,
                        date: currentPayment.date,
                        amount: currentPayment.amount
                    };
                }
                
                // University Header
                doc.setFontSize(20);
                doc.setTextColor(37, 99, 235);
                doc.text('ROCKVIEW UNIVERSITY', 105, 20, { align: 'center' });
                
                doc.setFontSize(14);
                doc.setTextColor(107, 114, 128);
                doc.text('Official Payment Receipt', 105, 30, { align: 'center' });
                doc.text('Student Payment System', 105, 37, { align: 'center' });
                
                // Receipt Details
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                
                let y = 60;
                const lineHeight = 10;
                
                const details = [
                    `Receipt ID: ${paymentData.receiptNumber}`,
                    `Student Name: ${paymentData.studentName}`,
                    `Student Number: ${paymentData.studentNumber}`,
                    `Program: ${paymentData.program}`,
                    `Payment Item: ${paymentData.item}`,
                    `Academic Term: Term ${paymentData.term}`,
                    `Payment Method: ${paymentData.methodName}`,
                    `Transaction ID: ${paymentData.transactionId}`,
                    `Payment Date: ${paymentData.date}`,
                    `Amount Paid: ${formatCurrency(paymentData.amount)}`
                ];
                
                details.forEach(detail => {
                    // Highlight the amount in green
                    if (detail.startsWith('Amount Paid:')) {
                        doc.setTextColor(16, 185, 129);
                        doc.setFontSize(14);
                        doc.text(detail, 20, y);
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(12);
                    } else {
                        doc.text(detail, 20, y);
                    }
                    y += lineHeight;
                });
                
                // Footer
                y += 10;
                doc.setFontSize(10);
                doc.setTextColor(107, 114, 128);
                doc.text('This is an official receipt from Rockview University', 105, y, { align: 'center' });
                y += 6;
                doc.text('For any inquiries, please contact the finance office', 105, y, { align: 'center' });
                y += 6;
                doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, y, { align: 'center' });
                
                // Save PDF
                const fileName = `receipt-${paymentData.transactionId}.pdf`;
                doc.save(fileName);
                showNotification('Receipt downloaded successfully!', 'success');
                
            } catch (error) {
                console.error("Error generating PDF:", error);
                showNotification("Failed to download receipt. Please try again.", 'error');
            }
        }

        // Data Loading Functions
        async function loadPaymentHistory() {
            const historyTableBody = document.getElementById('historyTableBody');
            historyTableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                        <div class="loading-spinner mx-auto mb-3"></div>
                        <p>Loading payment history...</p>
                    </td>
                </tr>
            `;
            
            try {
                if (!currentUser) {
                    historyTableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                                <i class="fas fa-user-lock text-3xl mb-3 opacity-50"></i>
                                <p>Please log in to view payment history</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                // Get payments from Firestore
                const payments = await loadPayments(currentUser.id);
                console.log('Loaded payments:', payments.length);
                renderPaymentHistory(payments);
                
            } catch (error) {
                console.error('Error loading payment history:', error);
                historyTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-red-500">
                            <i class="fas fa-exclamation-triangle text-3xl mb-3 opacity-50"></i>
                            <p>Error loading payment history: ${error.message}</p>
                        </td>
                    </tr>
                `;
            }
        }

        function renderPaymentHistory(payments) {
            const historyTableBody = document.getElementById('historyTableBody');
            
            if (payments.length === 0) {
                historyTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                            <i class="fas fa-receipt text-3xl mb-3 opacity-50"></i>
                            <p>No payment history found</p>
                            <p class="text-sm mt-2">Make your first payment to see it here</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            const rows = payments.map(payment => {
                const statusClass = payment.status === 'Success' ? 'status-success' : 
                                  payment.status === 'Pending' ? 'status-pending' : 'status-failed';
                return `
                    <tr class="hover:bg-gray-50 transition-colors duration-150">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${payment.date}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${payment.item}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">Term ${payment.term}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">${formatCurrency(payment.amount)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="status-badge ${statusClass}">${payment.status}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">
                            <button class="hover:underline flex items-center" onclick="downloadReceiptFromHistory('${payment.id}')">
                                <i class="fas fa-download mr-1"></i> Download
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            historyTableBody.innerHTML = rows;
        }

        // Download receipt from history
        window.downloadReceiptFromHistory = async function(paymentId) {
            try {
                showNotification('Fetching receipt data...', 'info');
                
                // Get payment data from Firestore
                const docRef = await db.collection('payments').doc(paymentId).get();
                if (!docRef.exists) {
                    throw new Error('Payment record not found');
                }
                
                const paymentData = docRef.data();
                
                // Set current payment data for receipt generation
                currentPayment = {
                    id: paymentData.id,
                    receiptNumber: paymentData.receiptNumber,
                    transactionId: paymentData.transactionId,
                    item: paymentData.item,
                    amount: paymentData.amount,
                    methodName: paymentData.methodName,
                    date: paymentData.date,
                    term: paymentData.term
                };
                
                // Generate and download receipt
                await downloadReceipt();
                
            } catch (error) {
                console.error('Error downloading receipt from history:', error);
                showNotification('Failed to download receipt. Please try again.', 'error');
            }
        }

        async function loadClearanceStatus() {
            try {
                if (!currentUser) {
                    document.getElementById('clearanceContainer').innerHTML = `
                        <div class="col-span-3 text-center py-8 text-gray-500">
                            <i class="fas fa-user-lock text-3xl mb-3 opacity-50"></i>
                            <p>Please log in to view clearance status</p>
                        </div>
                    `;
                    return;
                }

                // For now, we'll use a simple clearance status based on payments
                const payments = await loadPayments(currentUser.id);
                const clearanceData = {};
                
                // Group payments by term and mark items as paid
                payments.forEach(payment => {
                    if (!clearanceData[payment.term]) {
                        clearanceData[payment.term] = {};
                    }
                    clearanceData[payment.term][payment.item] = true;
                });
                
                renderClearanceStatus(clearanceData);
                
            } catch (error) {
                console.error('Error loading clearance status:', error);
                document.getElementById('clearanceContainer').innerHTML = `
                    <div class="col-span-3 text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-triangle text-3xl mb-3 opacity-50"></i>
                        <p>Error loading clearance status</p>
                    </div>
                `;
            }
        }

        function renderClearanceStatus(clearanceData) {
            const clearanceContainer = document.getElementById('clearanceContainer');
            
            const terms = [1, 2, 3];
            const clearanceHTML = terms.map(term => {
                const requiredItems = getPaymentItemsForTerm(term);
                const termClearance = clearanceData[term] || {};
                
                // Calculate completion percentage
                const paidItems = requiredItems.filter(item => termClearance[item.name] === true).length;
                const totalItems = requiredItems.length;
                const completionPercentage = totalItems > 0 ? Math.round((paidItems / totalItems) * 100) : 0;
                
                return `
                    <div class="bg-white rounded-xl p-6 border border-gray-200">
                        <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800">Term ${term} Clearance</h3>
                            <span class="text-sm font-medium ${completionPercentage === 100 ? 'text-green-600' : 'text-blue-600'}">
                                ${completionPercentage}%
                            </span>
                        </div>
                        <div class="space-y-3">
                            ${requiredItems.length > 0 ? 
                                requiredItems.map(item => {
                                    const isCleared = termClearance[item.name] === true;
                                    return `
                                        <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-b-0">
                                            <span class="text-sm ${isCleared ? 'text-gray-600' : 'text-gray-500'}">${item.name}</span>
                                            <span class="text-lg ${isCleared ? 'text-green-500' : 'text-red-500'}">
                                                ${isCleared ? '' : ''}
                                            </span>
                                        </div>
                                    `;
                                }).join('') : 
                                '<p class="text-gray-500 text-sm">No requirements for this term</p>'
                            }
                        </div>
                    </div>
                `;
            }).join('');
            
            clearanceContainer.innerHTML = clearanceHTML;
        }

        async function loadDashboardData() {
            try {
                if (!currentUser) return;
                
                // Get payments for dashboard stats
                const payments = await loadPayments(currentUser.id);
                
                // Update dashboard stats
                document.getElementById('paymentsCount').textContent = payments.length;
                
                // Calculate total balance (simplified - in real app would be based on tuition owed)
                const totalPaid = payments.reduce((sum, payment) => sum + payment.amount, 0);
                const estimatedBalance = 7500 - totalPaid; // Example calculation
                document.getElementById('currentBalance').textContent = formatCurrency(Math.max(0, estimatedBalance));
                
                // Update clearance status based on payments
                const clearanceData = {};
                payments.forEach(payment => {
                    if (!clearanceData[payment.term]) {
                        clearanceData[payment.term] = {};
                    }
                    clearanceData[payment.term][payment.item] = true;
                });
                
                const allTermsComplete = [1, 2, 3].every(term => {
                    const termData = clearanceData[term] || {};
                    const requiredItems = getPaymentItemsForTerm(term);
                    return requiredItems.every(item => termData[item.name] === true);
                });
                
                document.getElementById('clearanceStatus').textContent = allTermsComplete ? 'Cleared' : 'Pending';
                
                // Update recent payments
                const recentPayments = document.getElementById('recentPayments');
                if (payments.length > 0) {
                    recentPayments.innerHTML = payments.slice(0, 5).map(payment => `
                        <div class="flex items-center justify-between p-4 bg-white rounded-lg border border-gray-200">
                            <div>
                                <p class="font-medium text-gray-800">${payment.item}</p>
                                <p class="text-sm text-gray-500">Term ${payment.term}  ${payment.date}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold text-green-600">${formatCurrency(payment.amount)}</p>
                                <span class="status-badge status-success text-xs">Paid</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    recentPayments.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-receipt text-3xl mb-3 opacity-50"></i>
                            <p>No recent payments</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        window.downloadClearanceForm = function() {
            showNotification('Clearance form download feature coming soon!', 'info');
        }

        // Authentication
        window.handleLogout = function() {
            if (confirm("Are you sure you want to log out?")) {
                auth.signOut().then(() => {
                    showNotification("Logged out successfully", 'success');
                    // Redirect to login page
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 1000);
                }).catch((error) => {
                    showNotification("Logout failed: " + error.message, 'error');
                });
            }
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', async function() {
            // Check if user is logged in
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    try {
                        console.log('User signed in:', user.email);
                        
                        // User is signed in - get student data
                        const studentData = await getStudentData(user);
                        currentUser = studentData;
                        
                        // Update UI with student data
                        document.getElementById('headerStudentName').textContent = currentUser.fullName;
                        document.getElementById('headerStudentNumber').textContent = currentUser.studentNumber;
                        document.getElementById('displayUserId').textContent = currentUser.studentNumber;
                        document.getElementById('profileName').textContent = currentUser.fullName;
                        document.getElementById('profileStudentNumber').textContent = currentUser.studentNumber;
                        document.getElementById('profileEmail').textContent = currentUser.email;
                        document.getElementById('profileClass').textContent = currentUser.program;
                        document.getElementById('profileLevel').textContent = currentUser.level;
                        document.getElementById('profileStatus').textContent = 'Active';
                        
                        showNotification(`Welcome back, ${currentUser.fullName}!`, 'success');
                        
                        // Load initial data
                        loadPaymentHistory();
                        loadClearanceStatus();
                        loadDashboardData();
                        
                    } catch (error) {
                        console.error('Error initializing user data:', error);
                        showNotification('Error loading student data: ' + error.message, 'error');
                    }
                } else {
                    // User is signed out - redirect to login
                    showNotification('Please log in to continue', 'error');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                }
            });
        });
    </script>
</body>
</html>