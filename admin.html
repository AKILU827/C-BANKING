<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - School Payment System</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary-color);
        }
        .stat-card.success { border-left-color: var(--success-color); }
        .stat-card.warning { border-left-color: var(--warning-color); }
        .stat-card.error { border-left-color: var(--error-color); }
        .table-container {
            background: white;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-pending { background-color: #fef3c7; color: #d97706; }
        .status-approved { background-color: #d1fae5; color: #059669; }
        .status-rejected { background-color: #fee2e2; color: #dc2626; }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="messageBox" class="fixed top-4 right-4 z-50 hidden p-4 rounded-lg text-white"></div>

    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-3">
                    <div class="text-2xl">ðŸ’°</div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">Rockview University</h1>
                        <p class="text-sm text-gray-500">Admin Dashboard</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="adminName" class="text-gray-700">Loading...</span>
                    <button onclick="logout()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="loading-spinner"></div>
            <p class="mt-4 text-gray-600">Loading Admin Dashboard...</p>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" id="mainContent" style="display: none;">
        <!-- Stats Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3 class="text-lg font-semibold text-gray-900">Total Payments</h3>
                <p id="totalPayments" class="text-3xl font-bold text-gray-900">0</p>
                <p class="text-sm text-gray-500">All time payments</p>
            </div>
            <div class="stat-card warning">
                <h3 class="text-lg font-semibold text-gray-900">Pending Approval</h3>
                <p id="pendingPayments" class="text-3xl font-bold text-yellow-600">0</p>
                <p class="text-sm text-gray-500">Awaiting approval</p>
            </div>
            <div class="stat-card success">
                <h3 class="text-lg font-semibold text-gray-900">Approved Payments</h3>
                <p id="approvedPayments" class="text-3xl font-bold text-green-600">0</p>
                <p class="text-sm text-gray-500">Successfully approved</p>
            </div>
            <div class="stat-card error">
                <h3 class="text-lg font-semibold text-gray-900">Pending Clearance</h3>
                <p id="pendingClearance" class="text-3xl font-bold text-red-600">0</p>
                <p class="text-sm text-gray-500">Awaiting clearance</p>
            </div>
        </div>

        <!-- Tabs -->
        <div class="border-b border-gray-200 mb-6">
            <nav class="-mb-px flex space-x-8">
                <button id="tab-payments" class="tab-button border-b-2 border-blue-500 text-blue-600 py-4 px-1 text-sm font-medium" onclick="showTab('payments')">
                    Payment Approvals
                </button>
                <button id="tab-clearance" class="tab-button border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-sm font-medium" onclick="showTab('clearance')">
                    Clearance Management
                </button>
                <button id="tab-students" class="tab-button border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-sm font-medium" onclick="showTab('students')">
                    Student Management
                </button>
            </nav>
        </div>

        <!-- Payments Tab -->
        <div id="tab-content-payments" class="tab-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-900">Payment Approvals</h2>
                <div class="flex space-x-2">
                    <select id="paymentFilter" onchange="loadPayments()" class="border border-gray-300 rounded-lg px-3 py-2">
                        <option value="all">All Payments</option>
                        <option value="pending">Pending Approval</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
            </div>
            <div class="table-container">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Term</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="paymentsTableBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="7" class="px-6 py-4 text-center text-gray-500">Loading payments...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Clearance Tab -->
        <div id="tab-content-clearance" class="tab-content hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-900">Clearance Management</h2>
                <div class="flex space-x-2">
                    <select id="clearanceFilter" onchange="loadClearanceForms()" class="border border-gray-300 rounded-lg px-3 py-2">
                        <option value="all">All Forms</option>
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
            </div>
            <div class="table-container">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Form Number</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Academic Year</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Term</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="clearanceTableBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="7" class="px-6 py-4 text-center text-gray-500">Loading clearance forms...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Students Tab -->
        <div id="tab-content-students" class="tab-content hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-900">Student Management</h2>
                <div class="flex space-x-2">
                    <input type="text" id="studentSearch" placeholder="Search students..." class="border border-gray-300 rounded-lg px-3 py-2 w-64" onkeyup="searchStudents()">
                    <button onclick="showAddStudentModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        Add Student
                    </button>
                </div>
            </div>
            <div class="table-container">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student Number</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Program</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Level</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Clearance Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTableBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="7" class="px-6 py-4 text-center text-gray-500">Loading students...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Approval Modal -->
    <div id="approvalModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900" id="modalTitle">Approve Payment</h3>
                <div class="mt-2">
                    <p id="modalMessage">Are you sure you want to approve this payment?</p>
                    <div id="rejectionSection" class="mt-3 hidden">
                        <label for="rejectionReason" class="block text-sm font-medium text-gray-700">Rejection Reason</label>
                        <textarea id="rejectionReason" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="Enter reason for rejection..."></textarea>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-4">
                    <button id="cancelBtn" onclick="closeModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">Cancel</button>
                    <button id="confirmBtn" onclick="confirmAction()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div id="addStudentModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900">Add New Student</h3>
                <div class="mt-4 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Student Number</label>
                        <input type="text" id="newStudentNumber" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="RVU-XXXXX">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Full Name</label>
                        <input type="text" id="newStudentName" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="Full Name">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="newStudentEmail" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="email@student.rockview.edu">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Program</label>
                        <input type="text" id="newStudentProgram" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="BSc Computer Science">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Level</label>
                        <select id="newStudentLevel" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                            <option value="1st Year">1st Year</option>
                            <option value="2nd Year">2nd Year</option>
                            <option value="3rd Year">3rd Year</option>
                            <option value="4th Year">4th Year</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-4">
                    <button onclick="closeAddStudentModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">Cancel</button>
                    <button onclick="addNewStudent()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Add Student</button>
                </div>
            </div>
        </div>
    </div>
<script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyClWU6f1WdKKnJo3a4EEdusWdKdXd5LL4A",
        authDomain: "rockview-university-46057.firebaseapp.com",
        projectId: "rockview-university-46057",
        storageBucket: "rockview-university-46057.firebasestorage.app",
        messagingSenderId: "481696025854",
        appId: "1:481696025854:web:a2067380abde8f040c69af",
        measurementId: "G-5ZWLWVN1M7"
    };

    // Initialize Firebase
    try {
        firebase.initializeApp(firebaseConfig);
        console.log("Firebase initialized successfully");
    } catch (error) {
        console.error("Firebase initialization error:", error);
        showMessage("Firebase configuration error. Please check your configuration.", "error");
    }

    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentModalData = null;
    let currentAction = '';
    let allStudents = [];

    // Utility Functions
    function showMessage(message, type = 'success') {
        const box = document.getElementById('messageBox');
        box.textContent = message;
        box.className = `fixed top-4 right-4 z-50 p-4 rounded-lg text-white ${
            type === 'success' ? 'bg-green-600' : 
            type === 'error' ? 'bg-red-600' : 'bg-blue-600'
        }`;
        box.classList.remove('hidden');
        
        setTimeout(() => {
            box.classList.add('hidden');
        }, 5000);
    }

    function hideLoadingScreen() {
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
    }

    function showLoadingScreen() {
        document.getElementById('loadingScreen').style.display = 'flex';
        document.getElementById('mainContent').style.display = 'none';
    }

    // UPDATED AUTHENTICATION - Compatible with our system
    function checkAuth() {
        showLoadingScreen();
        
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                showMessage("Please log in to access the admin dashboard", "error");
                setTimeout(() => {
                    window.location.href = 'staff-login.html'; // Changed to staff login
                }, 2000);
                return;
            }
            
            try {
                console.log("User authenticated:", user.uid, user.email);
                
                // Check if user is admin in our system (using 'admins' collection)
                const adminDoc = await db.collection('admins').doc(user.uid).get();
                
                if (adminDoc.exists) {
                    // User is admin in our system
                    const adminData = adminDoc.data();
                    console.log("Admin data:", adminData);
                    
                    document.getElementById('adminName').textContent = adminData.fullName || user.email;
                    hideLoadingScreen();
                    
                    // Load initial data
                    loadDashboardStats();
                    loadPayments();
                    loadStudents(); // Load students initially
                    
                } else {
                    // User is not admin - redirect to student dashboard
                    showMessage("Access denied. Admin privileges required.", "error");
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                    return;
                }
                
            } catch (error) {
                console.error('Error checking admin status:', error);
                showMessage("Error verifying admin permissions: " + error.message, "error");
            }
        });
    }

    function logout() {
        auth.signOut().then(() => {
            showMessage("Logged out successfully", "success");
            setTimeout(() => {
                window.location.href = 'staff-login.html'; // Changed to staff login
            }, 1000);
        }).catch((error) => {
            console.error('Logout error:', error);
            showMessage("Error during logout", "error");
        });
    }

    // Initialize sample data that matches our system structure
    async function initializeSampleData() {
        try {
            // Check if we need to create sample data
            const paymentsSnapshot = await db.collection('payments').limit(1).get();
            
            if (paymentsSnapshot.empty) {
                console.log("No payments found. Sample payments will be created when students make payments.");
                // Sample payments will be created naturally when students use the system
            }
        } catch (error) {
            console.error("Error checking sample data:", error);
        }
    }

    // Tab Management
    function showTab(tabName) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.add('hidden');
        });
        
        // Remove active class from all tabs
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('border-blue-500', 'text-blue-600');
            button.classList.add('border-transparent', 'text-gray-500');
        });
        
        // Show selected tab and set active
        document.getElementById(`tab-content-${tabName}`).classList.remove('hidden');
        document.getElementById(`tab-${tabName}`).classList.add('border-blue-500', 'text-blue-600');
        document.getElementById(`tab-${tabName}`).classList.remove('border-transparent', 'text-gray-500');
        
        // Load tab data
        if (tabName === 'payments') loadPayments();
        if (tabName === 'clearance') loadClearanceForms();
        if (tabName === 'students') loadStudents();
    }

    // Modal Functions
    function showModal(action, paymentData) {
        console.log("showModal called with:", action, paymentData);
        currentModalData = paymentData;
        currentAction = action;
        const modal = document.getElementById('approvalModal');
        const title = document.getElementById('modalTitle');
        const message = document.getElementById('modalMessage');
        const confirmBtn = document.getElementById('confirmBtn');
        const rejectionSection = document.getElementById('rejectionSection');
        
        rejectionSection.classList.add('hidden');
        
        if (action === 'approve-payment') {
            title.textContent = 'Approve Payment';
            message.textContent = `Approve payment of $${paymentData.amount} for ${paymentData.item} by ${paymentData.studentName}?`;
            confirmBtn.textContent = 'Approve';
            confirmBtn.className = 'px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700';
        } else if (action === 'reject-payment') {
            title.textContent = 'Reject Payment';
            message.textContent = `Reject payment of $${paymentData.amount} for ${paymentData.item} by ${paymentData.studentName}?`;
            rejectionSection.classList.remove('hidden');
            confirmBtn.textContent = 'Reject';
            confirmBtn.className = 'px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700';
        }
        
        modal.classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('approvalModal').classList.add('hidden');
        currentModalData = null;
        currentAction = '';
        document.getElementById('rejectionReason').value = '';
    }

    async function confirmAction() {
        try {
            if (currentAction === 'approve-payment') {
                await db.collection('payments').doc(currentModalData.id).update({
                    approvalStatus: 'approved',
                    approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    approvedBy: auth.currentUser.uid
                });
                showMessage('Payment approved successfully!', 'success');
            } else if (currentAction === 'reject-payment') {
                const reason = document.getElementById('rejectionReason').value;
                await db.collection('payments').doc(currentModalData.id).update({
                    approvalStatus: 'rejected',
                    rejectionReason: reason,
                    rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    rejectedBy: auth.currentUser.uid
                });
                showMessage('Payment rejected successfully!', 'success');
            }
            
            closeModal();
            loadPayments();
            loadDashboardStats();
        } catch (error) {
            console.error('Error confirming action:', error);
            showMessage('Error processing request', 'error');
        }
    }

    // Student Modal Functions - UPDATED to match our system
    function showAddStudentModal() {
        document.getElementById('addStudentModal').classList.remove('hidden');
    }

    function closeAddStudentModal() {
        document.getElementById('addStudentModal').classList.add('hidden');
        // Clear form fields
        document.getElementById('newStudentNumber').value = '';
        document.getElementById('newStudentName').value = '';
        document.getElementById('newStudentEmail').value = '';
        document.getElementById('newStudentProgram').value = '';
        document.getElementById('newStudentLevel').value = '1st Year';
    }

    async function addNewStudent() {
        const studentNumber = document.getElementById('newStudentNumber').value.trim();
        const name = document.getElementById('newStudentName').value.trim();
        const email = document.getElementById('newStudentEmail').value.trim();
        const program = document.getElementById('newStudentProgram').value.trim();
        const level = document.getElementById('newStudentLevel').value;

        if (!studentNumber || !name || !email || !program) {
            showMessage('Please fill in all required fields', 'error');
            return;
        }

        try {
            // Check if student number already exists
            const existingStudent = await db.collection('students')
                .where('studentNumber', '==', studentNumber)
                .get();

            if (!existingStudent.empty) {
                showMessage('Student number already exists', 'error');
                return;
            }

            // Add new student with our system's structure
            const [firstName, ...lastNameParts] = name.split(' ');
            const lastName = lastNameParts.join(' ');

            await db.collection('students').add({
                studentNumber,
                fullName: name,
                firstName: firstName,
                lastName: lastName,
                email,
                program,
                level,
                status: 'active',
                clearanceStatus: 'pending',
                role: 'student',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            showMessage('Student added successfully!', 'success');
            closeAddStudentModal();
            loadStudents();
        } catch (error) {
            console.error('Error adding student:', error);
            showMessage('Error adding student', 'error');
        }
    }

    // Data Loading Functions - UPDATED for compatibility
    async function loadDashboardStats() {
        try {
            const paymentsSnapshot = await db.collection('payments').get();
            const totalPayments = paymentsSnapshot.size;
            const pendingPayments = paymentsSnapshot.docs.filter(doc => 
                doc.data().approvalStatus === 'pending'
            ).length;
            const approvedPayments = paymentsSnapshot.docs.filter(doc => 
                doc.data().approvalStatus === 'approved'
            ).length;

            // Count pending clearance forms
            let pendingClearance = 0;
            try {
                const clearanceSnapshot = await db.collection('clearanceForms')
                    .where('status', '==', 'pending')
                    .get();
                pendingClearance = clearanceSnapshot.size;
            } catch (error) {
                console.log("No clearance forms collection found");
                // Count students with pending clearance instead
                const studentsSnapshot = await db.collection('students')
                    .where('clearanceStatus', '==', 'pending')
                    .get();
                pendingClearance = studentsSnapshot.size;
            }
            
            document.getElementById('totalPayments').textContent = totalPayments;
            document.getElementById('pendingPayments').textContent = pendingPayments;
            document.getElementById('approvedPayments').textContent = approvedPayments;
            document.getElementById('pendingClearance').textContent = pendingClearance;
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }

    async function loadPayments() {
        const filter = document.getElementById('paymentFilter').value;
        try {
            let query = db.collection('payments').orderBy('createdAt', 'desc');
            
            if (filter !== 'all') {
                query = query.where('approvalStatus', '==', filter);
            }
            
            const snapshot = await query.get();
            const tbody = document.getElementById('paymentsTableBody');
            tbody.innerHTML = '';
            
            if (snapshot.empty) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No payments found</td></tr>';
                return;
            }
            
            // Use the student data already stored in payments (from our updated sample data)
            snapshot.docs.forEach(doc => {
                const payment = { id: doc.id, ...doc.data() };
                const row = document.createElement('tr');
                
                // Create a clean data object for the modal
                const modalData = {
                    id: payment.id,
                    amount: payment.amount,
                    item: payment.item,
                    studentName: payment.studentName || 'Unknown Student'
                };
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${payment.studentName || 'Unknown Student'}</div>
                        <div class="text-sm text-gray-500">${payment.studentNumber || 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${payment.item}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${payment.term}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$${payment.amount}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(payment.date).toLocaleDateString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="status-badge ${getStatusClass(payment.approvalStatus)}">${payment.approvalStatus}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        ${payment.approvalStatus === 'pending' ? `
                            <button onclick="showModal('approve-payment', ${JSON.stringify(modalData).replace(/"/g, '&quot;')})" class="text-green-600 hover:text-green-900 mr-3">Approve</button>
                            <button onclick="showModal('reject-payment', ${JSON.stringify(modalData).replace(/"/g, '&quot;')})" class="text-red-600 hover:text-red-900">Reject</button>
                        ` : `
                            <span class="text-gray-500">Completed</span>
                        `}
                    </td>
                `;
                tbody.appendChild(row);
            });
        } catch (error) {
            console.error('Error loading payments:', error);
            showMessage('Error loading payments', 'error');
        }
    }

    async function loadClearanceForms() {
        try {
            // For now, use students data since we don't have a separate clearanceForms collection
            const snapshot = await db.collection('students').orderBy('createdAt', 'desc').get();
            const tbody = document.getElementById('clearanceTableBody');
            tbody.innerHTML = '';
            
            if (snapshot.empty) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No students found</td></tr>';
                return;
            }
            
            snapshot.docs.forEach(doc => {
                const student = { id: doc.id, ...doc.data() };
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${student.fullName || student.name}</div>
                        <div class="text-sm text-gray-500">${student.studentNumber}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">CLR-${student.studentNumber}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">2024</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.level}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="status-badge ${getStatusClass(student.clearanceStatus)}">${student.clearanceStatus}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.createdAt ? new Date(student.createdAt.toDate()).toLocaleDateString() : 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="text-blue-600 hover:text-blue-900 mr-3">View</button>
                        ${student.clearanceStatus === 'pending' ? `
                            <button class="text-green-600 hover:text-green-900 mr-3">Approve</button>
                            <button class="text-red-600 hover:text-red-900">Reject</button>
                        ` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        } catch (error) {
            console.error('Error loading clearance forms:', error);
            showMessage('Error loading clearance forms', 'error');
        }
    }

    async function loadStudents() {
        try {
            const snapshot = await db.collection('students').orderBy('createdAt', 'desc').get();
            const tbody = document.getElementById('studentsTableBody');
            tbody.innerHTML = '';
            
            if (snapshot.empty) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No students found</td></tr>';
                return;
            }
            
            allStudents = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            displayStudents(allStudents);
        } catch (error) {
            console.error('Error loading students:', error);
            showMessage('Error loading students', 'error');
        }
    }

    function displayStudents(students) {
        const tbody = document.getElementById('studentsTableBody');
        tbody.innerHTML = '';
        
        students.forEach(student => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.studentNumber}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.fullName || student.name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.program}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.level}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="status-badge ${student.status === 'active' ? 'status-approved' : 'status-rejected'}">${student.status}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="status-badge ${getStatusClass(student.clearanceStatus)}">${student.clearanceStatus}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                    <button class="text-red-600 hover:text-red-900">Delete</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function searchStudents() {
        const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
        const filteredStudents = allStudents.filter(student => 
            (student.fullName || student.name).toLowerCase().includes(searchTerm) ||
            student.studentNumber.toLowerCase().includes(searchTerm) ||
            student.program.toLowerCase().includes(searchTerm)
        );
        displayStudents(filteredStudents);
    }

    function getStatusClass(status) {
        switch (status) {
            case 'pending': return 'status-pending';
            case 'approved': return 'status-approved';
            case 'rejected': return 'status-rejected';
            default: return 'status-pending';
        }
    }

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        checkAuth();
        // Initialize sample data on first load
        initializeSampleData();
    });
</script>
   